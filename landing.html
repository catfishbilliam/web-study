<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Information Evaluation Study â€” Survey</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Part 1: Survey</h1>
    <p class="muted">
      Please complete the brief survey below. Once submitted, the button to continue will unlock automatically.
    </p>

    <!-- Embedded Google Form -->
    <iframe id="surveyFrame" class="form-frame" loading="lazy" title="Survey"></iframe>

    <div style="text-align:center; margin-top:20px;">
      <button id="continueBtn" class="btn disabled" disabled>Continue to Part 2</button>
      <p id="formStatus" class="muted small" style="margin-top:8px;">Please complete the survey first.</p>
    </div>
  </div>

  <script>
    // Read Prolific params
    const qs = new URLSearchParams(location.search);
    const PID = qs.get("PROLIFIC_PID") || "";
    const STUDY_ID = qs.get("STUDY_ID") || "";
    const SESSION_ID = qs.get("SESSION_ID") || "";
  
    // Prefill your Google Form (embedded)
    const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSfZSotW8pdpndlmkS53GGLxMPHwUCod10xghOydO30xXmwHHA/viewform";
    const ENTRY_ID_FOR_PID = "entry.66279277"; // your PID field
    const formUrl = PID
      ? `${FORM_BASE}?embedded=true&usp=pp_url&${ENTRY_ID_FOR_PID}=${encodeURIComponent(PID)}`
      : `${FORM_BASE}?embedded=true`;
    const frame = document.getElementById("surveyFrame");
    frame.src = formUrl;
  
    const continueBtn = document.getElementById("continueBtn");
    const formStatus = document.getElementById("formStatus");
  
    // ---- Server-side check: has this PID submitted the survey? ----
    const CHECK_ENDPOINT = "https://script.google.com/macros/s/AKfycbwJaswrvUTZMN_XseRLBT_4RvwlW8WzX9-6P3J00haf4n95UXOPHYIxcvDYKnQLJFsXPA/exec";
  
    async function checkSubmitted() {
      if (!PID) return false; // if no PID, we can't prove it
      try {
        const url = `${CHECK_ENDPOINT}?fn=checkSurvey&pid=${encodeURIComponent(PID)}`;
        const res = await fetch(url, { method: "GET", cache: "no-store" });
        const data = await res.json();
        return !!(data && data.ok && data.submitted === true);
      } catch (e) {
        return false;
      }
    }
  
    function buildTaskUrl() {
      const url = new URL("task.html", location.href);
      if (PID) url.searchParams.set("PROLIFIC_PID", PID);
      if (STUDY_ID) url.searchParams.set("STUDY_ID", STUDY_ID);
      if (SESSION_ID) url.searchParams.set("SESSION_ID", SESSION_ID);
      return url.toString();
    }
  
    // Poll every 5s until the server sees a row with this PID
    let pollTimer = null;
    async function startPolling() {
      formStatus.textContent = "Please complete the survey first.";
      continueBtn.disabled = true;
      continueBtn.classList.add("disabled");
      continueBtn.classList.remove("primary");
  
      const tryOnce = async () => {
        const ok = await checkSubmitted();
        if (ok) {
          clearInterval(pollTimer);
          formStatus.textContent = "Survey submitted! You may now continue.";
          continueBtn.disabled = false;
          continueBtn.classList.remove("disabled");
          continueBtn.classList.add("primary");
        }
      };
  
      await tryOnce(); // quick first check
      pollTimer = setInterval(tryOnce, 5000);
    }
  
    // Manual continue (only works after unlock)
    continueBtn.addEventListener("click", () => {
      if (continueBtn.disabled) return;
      location.href = buildTaskUrl();
    });
  
    // Start polling when the page is ready
    startPolling();
  </script>
</body>
</html>