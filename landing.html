<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Information Evaluation Study â€” Survey</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Part 1: Survey</h1>
    <p class="muted">
      Please complete the brief survey below. Once submitted, the button to continue will unlock automatically.
    </p>

    <!-- Embedded Google Form -->
    <iframe id="surveyFrame" class="form-frame" loading="lazy" title="Survey"></iframe>

    <div style="text-align:center; margin-top:20px;">
      <button id="continueBtn" class="btn disabled" disabled>Continue to Part 2</button>
      <p id="formStatus" class="muted small" style="margin-top:8px;">Please complete the survey first.</p>
    </div>
  </div>

  <script>
    // Read Prolific parameters
    const qs = new URLSearchParams(location.search);
    const PID = qs.get("PROLIFIC_PID") || "";
    const STUDY_ID = qs.get("STUDY_ID") || "";
    const SESSION_ID = qs.get("SESSION_ID") || "";

    // Prefilled Google Form embed
    const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSfZSotW8pdpndlmkS53GGLxMPHwUCod10xghOydO30xXmwHHA/viewform";
    const ENTRY_ID_FOR_PID = "entry.66279277"; // Prolific ID field
    const formUrl = PID
      ? `${FORM_BASE}?embedded=true&usp=pp_url&${ENTRY_ID_FOR_PID}=${encodeURIComponent(PID)}`
      : `${FORM_BASE}?embedded=true`;
    const frame = document.getElementById("surveyFrame");
    frame.src = formUrl;

    const continueBtn = document.getElementById("continueBtn");
    const formStatus = document.getElementById("formStatus");

    // Detect when the form has been submitted
    let lastUrl = "";
    const checkInterval = setInterval(() => {
      try {
        const currentUrl = frame.contentWindow.location.href;
        if (currentUrl !== lastUrl) {
          lastUrl = currentUrl;
          if (currentUrl.includes("formResponse")) {
            clearInterval(checkInterval);
            continueBtn.disabled = false;
            continueBtn.classList.remove("disabled");
            continueBtn.classList.add("primary");
            formStatus.textContent = "Survey submitted! You may now continue.";
          }
        }
      } catch (err) {
        // Ignore cross-origin errors until form changes to formResponse
      }
    }, 1000);

    // Continue to Part 2 (task.html)
    continueBtn.addEventListener("click", () => {
      if (continueBtn.disabled) return;
      const url = new URL("task.html", location.href);
      if (PID) url.searchParams.set("PROLIFIC_PID", PID);
      if (STUDY_ID) url.searchParams.set("STUDY_ID", STUDY_ID);
      if (SESSION_ID) url.searchParams.set("SESSION_ID", SESSION_ID);
      location.href = url.toString();
    });
  </script>
</body>
</html>